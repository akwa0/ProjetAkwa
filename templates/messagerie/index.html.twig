{% extends 'base.html.twig' %}

{% block title %}Messagerie{% endblock %}

{% block body %}
<link rel="stylesheet" href="{{ asset('pages/style.css') }}">

<a href="#" class="logo-button" onclick="toggleUserMenu(event)">
    <img src="{{ asset('/image/Illustration_sans_titre 12.png') }}" alt="Logo" class="logo-icon">
</a>

<div id="userMenu" class="user-menu hidden">
    <div class="user-menu-content">
        <p class="user-name">Connect√© en tant que</p>
        <p class="user-username">{{ app.user.nom }}</p>
        <button type="submit" class="logout-btn" form="logoutForm">Se d√©connecter</button>
        <form action="{{ path('app_logout') }}" method="post" class="logout-form" id="logoutForm" style="display: none;">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
        </form>
    </div>
</div>

<div class="page-container">
    <h1 class="page-title">Messagerie üí¨</h1>

    {% if nonLus > 0 %}
        <div class="info-message success">
            <strong>Vous avez {{ nonLus }} message(s) non lu(s)</strong>
        </div>
    {% endif %}

    {% if messages | length > 0 %}
        <div class="conversation-list">
            {% set contacts = {} %}
            {% for message in messages %}
                {% set contactId = message.emetteur.id %}
                {% if contactId not in contacts %}
                    {% set contacts = contacts | merge({(contactId): message.emetteur}) %}
                    <a href="{{ path('app_messagerie_conversation', {'id': message.emetteur.id}) }}" class="conversation-item">
                        {% if message.emetteur.profilImage %}
                            <img src="{{ asset('uploads/' ~ message.emetteur.profilImage) }}"
                                 alt="{{ message.emetteur.nom }}"
                                 class="conversation-avatar">
                        {% else %}
                            <div class="conversation-avatar" style="background: linear-gradient(135deg, #c865de 0%, #eddeef 100%); display: flex; align-items: center; justify-content: center; color: #333; font-weight: 600;">
                                {{ message.emetteur.nom | first }}
                            </div>
                        {% endif %}

                        <div class="conversation-info">
                            <div class="conversation-name">{{ message.emetteur.nom }}</div>
                            <div class="conversation-preview">{{ message.contenu | slice(0, 60) }}{% if message.contenu | length > 60 %}...{% endif %}</div>
                        </div>

                        <div class="conversation-meta">
                            <div class="conversation-date">{{ message.dateEnvoie | date('d/m H:i') }}</div>
                            {% if not message.lu %}
                                <span class="unread-badge">Non lu</span>
                            {% endif %}
                        </div>
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h3>Aucune conversation</h3>
            <p>Vous n'avez pas encore de conversations. Commencez par chercher un artiste et envoyez-lui un message!</p>
            <a href="{{ path('app_search_professionals') }}" class="empty-state-btn">Rechercher un artiste</a>
        </div>
    {% endif %}

    <a href="{{ path('app_compte_client') }}" class="back-button">‚Üê Retour au compte</a>
</div>

<script>
    function toggleUserMenu(event) {
        event.preventDefault();
        const menu = document.getElementById('userMenu');
        menu.classList.toggle('hidden');
    }

    document.addEventListener('click', function(event) {
        const menu = document.getElementById('userMenu');
        const logoBtn = document.querySelector('.logo-button');
        if (!menu.contains(event.target) && !logoBtn.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });
</script>
{% endblock %}
