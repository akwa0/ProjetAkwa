{% extends 'base.html.twig' %}

{% block title %}Mes publications aimées{% endblock %}

{% block body %}
<link rel="stylesheet" href="{{ asset('pages/style.css') }}">

<a href="#" class="logo-button" onclick="toggleUserMenu(event)">
    <img src="{{ asset('/image/Illustration_sans_titre 12.png') }}" alt="Logo" class="logo-icon">
</a>

<div id="userMenu" class="user-menu hidden">
    <div class="user-menu-content">
        <p class="user-name">Connecté en tant que</p>
        <p class="user-username">{{ app.user.nom }}</p>
        <form action="{{ path('app_logout') }}" method="post" class="logout-form" id="logoutForm">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
        </form>
        <button type="button" class="logout-btn" onclick="document.getElementById('logoutForm').submit();">Se déconnecter</button>
    </div>
</div>

<div class="page-container">
    <h1 class="page-title">❤️ Publications Aimées</h1>

    <div style="text-align: center; margin-bottom: 30px; color: #666;">
        Total : <strong>{{ totalLikes }}</strong> publication(s)
    </div>

    {% if likes | length > 0 %}
        <div class="photos-grid">
            {% for like in likes %}
                {% set photo = like.photo %}
                {% set professionnel = photo.photoPoster %}
                <div class="photo-card">
                    <div class="photo-image-container">
                        <img src="{{ asset('uploads/' ~ photo.filename) }}"
                             alt="{{ photo.description }}"
                             class="photo-image">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); padding: 20px; color: white;">
                            <div style="font-weight: 600; font-size: 16px;">{{ professionnel.nom }}</div>
                            {% if professionnel.style %}
                                <div style="font-size: 12px; opacity: 0.9;">{{ professionnel.style }}</div>
                            {% endif %}
                        </div>
                        <button class="like-button liked"
                                data-photo-id="{{ photo.id }}">
                            ❤️
                        </button>
                    </div>

                    <div class="photo-card-body">
                        {% if photo.description %}
                            <p class="photo-description">{{ photo.description }}</p>
                        {% endif %}

                        <div class="photo-likes" id="like-count-{{ photo.id }}">
                            {{ photo.likes | length }}
                            {% if photo.likes | length == 1 %}like{% else %}likes{% endif %}
                        </div>

                        <div class="photo-date">
                            Liké le {{ like.dateLike | date('d/m/Y à H:i') }}
                        </div>

                        <a href="{{ path('app_profil_public', {'id': professionnel.id}) }}" class="photo-btn">
                            Voir le profil
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h3>Aucune publication aimée</h3>
            <p>Vous n'avez pas encore liké de publication. Découvrez des artistes et leurs créations!</p>
            <a href="{{ path('app_search_professionals') }}" class="empty-state-btn">Découvrir des professionnels</a>
        </div>
    {% endif %}

    <a href="{{ path('app_compte_client') }}" class="back-button">← Retour au compte</a>
</div>

<script>
    function toggleUserMenu(event) {
        event.preventDefault();
        const menu = document.getElementById('userMenu');
        menu.classList.toggle('hidden');
    }

    document.addEventListener('click', function(event) {
        const menu = document.getElementById('userMenu');
        const logoBtn = document.querySelector('.logo-button');
        if (!menu.contains(event.target) && !logoBtn.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });

document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-button');

    likeButtons.forEach(button => {
        const photoId = button.dataset.photoId;

        button.addEventListener('click', function(e) {
            e.preventDefault();

            fetch(`{{ path('app_like_toggle_photo', {'id': 0}) }}`.replace('0', photoId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.liked) {
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                }

                const likeCountElement = document.getElementById(`like-count-${photoId}`);
                if (likeCountElement) {
                    const count = data.likeCount;
                    likeCountElement.textContent = `${count} ${count === 1 ? 'like' : 'likes'}`;
                }
            })
            .catch(error => console.error('Erreur:', error));
        });
    });
});
</script>
{% endblock %}
